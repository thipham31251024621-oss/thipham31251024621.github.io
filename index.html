<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Focus App (Frontend + Backend Giả Lập)</title>
<style>
    body { font-family: Arial; margin: 30px; }
    button { padding: 8px 12px; margin: 5px; }
    #app { margin-top: 25px; }
</style>
</head>
<body>

<h1>✔ Focus App – Backend Giả Lập Trong Frontend</h1>

<div>
    <button onclick="showRegister()">Đăng ký</button>
    <button onclick="showLogin()">Đăng nhập</button>
    <button onclick="logout()">Đăng xuất</button>
</div>

<div id="app"></div>

<script>
/* ============================================================================
    BACKEND GIẢ LẬP - FakeServer
    (mô phỏng API: /auth/login, /auth/register, /quests, /user, /store...)
=============================================================================*/
const FakeServer = {
    load() {
        const db = localStorage.getItem("FAKE_DB");
        if (db) return JSON.parse(db);
        const init = { users: [], quests: {}, sessions: {}, store: [
            {id:1, title:"Voucher 50 FP", cost:50},
            {id:2, title:"Theme Premium", cost:20}
        ]};
        localStorage.setItem("FAKE_DB", JSON.stringify(init));
        return init;
    },

    save(db) { localStorage.setItem("FAKE_DB", JSON.stringify(db)); },

    makeToken(userId) {
        return "token_" + userId + "_" + Date.now();
    },

    api(endpoint, method = "GET", body = null, token = null) {
        return new Promise(res => {
            setTimeout(() => res(FakeServer.route(endpoint, method, body, token)), 200);
        });
    },

    route(endpoint, method, body, token) {
        const db = FakeServer.load();

        // ------------------ AUTH ------------------
        if (endpoint === "/auth/register" && method === "POST") {
            if (db.users.some(u => u.email === body.email))
                return { error: "Email đã tồn tại" };

            const user = {
                id: Date.now(),
                email: body.email,
                name: body.name,
                password: body.password,
                fp: 0,
                chain: 0,
                avatar: "",
                subjectSeconds: {}
            };
            db.users.push(user);
            FakeServer.save(db);
            return { user, token: FakeServer.makeToken(user.id) };
        }

        if (endpoint === "/auth/login" && method === "POST") {
            const user = db.users.find(u => u.email === body.email && u.password === body.password);
            if (!user) return { error: "Sai email hoặc mật khẩu" };
            return { user, token: FakeServer.makeToken(user.id) };
        }

        // ------------------ AUTH MIDDLEWARE ------------------
        if (!token) return { error: "Thiếu token" };
        const userId = parseInt(token.split("_")[1]);
        const user = db.users.find(u => u.id === userId);
        if (!user) return { error: "Token không hợp lệ" };

        // ------------------ USER ------------------
        if (endpoint === "/user/me") {
            return { user };
        }

        // ------------------ QUEST ------------------
        if (endpoint === "/quests" && method === "GET") {
            return { quests: db.quests[userId] || [] };
        }

        if (endpoint === "/quests" && method === "POST") {
            if (!db.quests[userId]) db.quests[userId] = [];
            const q = { id: Date.now(), text: body.text, done: false };
            db.quests[userId].push(q);
            FakeServer.save(db);
            return { quest: q };
        }

        if (endpoint.startsWith("/quests/") && method === "PATCH") {
            const id = parseInt(endpoint.split("/")[2]);
            const list = db.quests[userId] || [];
            const q = list.find(x => x.id === id);
            if (!q) return { error: "Không tìm thấy quest" };
            q.done = !q.done;
            FakeServer.save(db);
            return { quest: q };
        }

        // ------------------ STORE ------------------
        if (endpoint === "/store" && method === "GET") {
            return { items: db.store };
        }

        if (endpoint === "/store/redeem" && method === "POST") {
            const item = db.store.find(i => i.id == body.id);
            if (!item) return { error: "Không có item" };
            if (user.fp < item.cost) return { error: "Không đủ FP" };

            user.fp -= item.cost;
            FakeServer.save(db);
            return { ok: true, item };
        }

        return { error: "Endpoint không tồn tại" };
    }
};

/* ============================================================================
    FRONTEND (giao tiếp backend qua FakeServer.api)
=============================================================================*/

// GLOBAL STATE
let TOKEN = localStorage.getItem("TOKEN") || "";

// ------------------ UI RENDER ------------------
function showRegister() {
    app.innerHTML = `
        <h2>Đăng ký</h2>
        <input id="rEmail" placeholder="Email"><br><br>
        <input id="rName" placeholder="Tên"><br><br>
        <input id="rPass" placeholder="Mật khẩu" type="password"><br><br>
        <button onclick="register()">Đăng ký</button>
    `;
}

function showLogin() {
    app.innerHTML = `
        <h2>Đăng nhập</h2>
        <input id="lEmail" placeholder="Email"><br><br>
        <input id="lPass" placeholder="Mật khẩu" type="password"><br><br>
        <button onclick="login()">Đăng nhập</button>
    `;
}

async function showHome() {
    const me = await FakeServer.api("/user/me", "GET", null, TOKEN);

    if (me.error) return showLogin();

    app.innerHTML = `
        <h2>Xin chào, ${me.user.name}</h2>
        <p>FP: ${me.user.fp}</p>
        <button onclick="showQuests()">Nhiệm vụ</button>
        <button onclick="showStore()">Cửa hàng</button>
    `;
}

async function showQuests() {
    const res = await FakeServer.api("/quests", "GET", null, TOKEN);
    if (res.error) return alert(res.error);

    let html = `
        <h2>Nhiệm vụ</h2>
        <input id="qText" placeholder="Nhiệm vụ mới">
        <button onclick="createQuest()">Thêm</button>
        <ul>
    `;

    res.quests.forEach(q => {
        html += `
            <li>
                <label>
                    <input type="checkbox" onchange="toggleQuest(${q.id})" ${q.done?"checked":""}>
                    ${q.text}
                </label>
            </li>
        `;
    });

    html += `</ul><button onclick="showHome()">Trang chủ</button>`;

    app.innerHTML = html;
}

async function showStore() {
    const res = await FakeServer.api("/store", "GET", null, TOKEN);
    if (res.error) return alert(res.error);

    let html = `<h2>Cửa hàng</h2><ul>`;
    res.items.forEach(i => {
        html += `<li>${i.title} – ${i.cost} FP 
            <button onclick="redeem(${i.id})">Đổi</button></li>`;
    });
    html += `</ul><button onclick="showHome()">Trang chủ</button>`;

    app.innerHTML = html;
}

// ------------------ ACTIONS ------------------
async function register() {
    const email = rEmail.value;
    const name = rName.value;
    const password = rPass.value;

    const res = await FakeServer.api("/auth/register", "POST", { email, name, password });

    if (res.error) return alert(res.error);

    TOKEN = res.token;
    localStorage.setItem("TOKEN", TOKEN);
    showHome();
}

async function login() {
    const email = lEmail.value;
    const password = lPass.value;

    const res = await FakeServer.api("/auth/login", "POST", { email, password });

    if (res.error) return alert(res.error);

    TOKEN = res.token;
    localStorage.setItem("TOKEN", TOKEN);
    showHome();
}

function logout() {
    TOKEN = "";
    localStorage.removeItem("TOKEN");
    showLogin();
}

async function createQuest() {
    const text = qText.value;
    const res = await FakeServer.api("/quests", "POST", { text }, TOKEN);
    if (res.error) return alert(res.error);
    showQuests();
}

async function toggleQuest(id) {
    await FakeServer.api(`/quests/${id}`, "PATCH", {}, TOKEN);
    showQuests();
}

async function redeem(id) {
    const res = await FakeServer.api("/store/redeem", "POST", { id }, TOKEN);
    if (res.error) return alert(res.error);
    alert("Đổi vật phẩm thành công!");
    showStore();
}

// ---------------- INIT ----------------
showHome();
</script>
</body>
</html>
